<template>
  <!-- class="section" on the following div makes the table rows vertically aligned -->
  <div>
    <b-tabs>
      <b-tab-item label="Table">
        <b-table
          ref="table"
          :data="rows"
          :selected.sync="selected"
          focusable
          hoverable
          paginated
          @dblclick="navigateToRowDetailView"
          :per-page="10"
        >
          <b-table-column label="Provider" v-slot="props">
            <provider :provider="props.row.provider"> </provider>
          </b-table-column>

          <b-table-column label="Primary" v-slot="props">
            {{ props.row.preferred }}
          </b-table-column>
        </b-table>
      </b-tab-item>

      <b-tab-item label="Selected">
        <client-provider-relationship
          v-if="selected && selected.logo_url"
          :relationship="selected"
        >
        </client-provider-relationship>
      </b-tab-item>
    </b-tabs>
  </div>
</template>

<script lang="ts">
import Vue from "vue";
import BTable from "buefy/src/components/table";
type BTableInstance = InstanceType<typeof BTable>;

import { ClientProviderRelationship as IClientProviderRelationship } from "../autogenerated-interfaces/client";
import Provider from "./Provider.vue";
import http from "../http";

export default Vue.extend({
  components: { Provider },
  data() {
    return {
      rows: [] as IClientProviderRelationship[],
      selected: {},
    };
  },

  async created(): Promise<void> {
    this.fetchClientProviderRelationshipList();
  },

  mounted() {
    this.$el.querySelector("table")?.addEventListener("keydown", (event) => {
      if (event.code === "Enter") {
        let table = this.$refs.table as BTableInstance;
        if (table.selected) {
          this.navigateToRowDetailView(table.selected);
        }
      }
    });
  },

  methods: {
    async fetchClientProviderRelationshipList(): Promise<void> {
      this.rows =
        (await http.fetchDataOrNull(
          "/api/client-contact/list-provider-relationships/"
        )) || [];
    },

    navigateToRowDetailView(row: IClientProviderRelationship): void {
      this.$router.push(`/portal/provider/${row.uuid}`);
    },
  },
});
</script>
