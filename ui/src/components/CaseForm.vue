  <template>
  <div>
    <section class="section">
      <case v-if="haveApplicant" :case_="case_" :showClient="false"> </case>

      <div class="form pt-6">
        <applicant-selector
          label="Applicant"
          @change:applicant="handleChangeApplicant"
          class="applicant-selector"
        >
        </applicant-selector>

        <country-selector
          label="Host country"
          @change:country="handleChangeHostCountry"
          class="country-selector"
        >
        </country-selector>

        <b-field label="Target dates" class="date-range-selector">
          <b-datepicker
            :range="true"
            :mobile-native="false"
            @input="handleInputDateRange"
          >
          </b-datepicker>
        </b-field>

        <fieldset :disabled="processes.length === 0">
          <route-selector
            label="Route"
            :processes="processes"
            @change:process="handleChangeProcess"
            class="route-selector"
          >
          </route-selector>
        </fieldset>

        <fieldset :disabled="!haveProcess">
          <provider-contact-selector
            label="Provider"
            :giveAppearanceOfSelectingProvider="true"
            :process="case_.process"
            :initialProviderContacts="[]"
            @select:provider-contact="handleSelectProviderContact"
            class="provider-contact-selector"
          >
          </provider-contact-selector>
        </fieldset>

        <fieldset>
          <div class="field is-grouped pt-4">
            <div class="control">
              <button
                class="button is-link"
                ref="submitButton"
                @click="handleSubmit"
              >
                Submit
              </button>
            </div>
          </div>
        </fieldset>
      </div>
      <div>
        <vue-json-pretty
          v-if="validationErrors"
          :path="'res'"
          :data="validationErrors"
          class="mt-4"
        >
        </vue-json-pretty>
      </div>
    </section>
  </div>
</template>

<script lang="ts">
import Vue from "vue";

import VueJsonPretty from "vue-json-pretty";
import "vue-json-pretty/lib/styles.css";
import { NotificationProgrammatic as Notification } from "buefy";

import {
  CountrySerializer,
  ApplicantSerializer,
  ProcessSerializer,
  ProviderContactSerializer,
} from "../autogenerated-interfaces";
import Case from "../components/Case.vue";
import {
  NullCase,
  applicantIsNull,
  processIsNull,
  NullProviderContact,
} from "@/factories";
import CountrySelector from "./CountrySelector.vue";
import ApplicantSelector from "./ApplicantSelector.vue";
import ProviderContactSelector from "./ProviderContactSelector.vue";
import RouteSelector from "./RouteSelector.vue";
import http from "../http";
import { showMessages } from "../server-messages";
import { dateToYYYYMMDD } from "../utils";

export default Vue.extend({
  components: {
    Case,
    CountrySelector,
    ApplicantSelector,
    ProviderContactSelector,
    RouteSelector,
    VueJsonPretty,
  },

  data() {
    return {
      case_: NullCase(),
      input: {
        route: "",
      },
      // All processes matching country, applicant nationalities & home country, dates
      processes: [] as ProcessSerializer[],
      // Subset of those processes matching selected route
      validationErrors: null as object | null,
      // Provider contacts are linked indendently to each case step; the case
      // itself does not have a provider contact. However, the form gives the
      // appearance to the user that they are selecting a single provider
      // contact for the case. This is stored in the following value, and is
      // copied to each of the case steps.
      defaultProviderContact: NullProviderContact() as ProviderContactSerializer,
    };
  },

  computed: {
    haveApplicant(): boolean {
      return !applicantIsNull(this.case_.applicant);
    },

    haveProcess(): boolean {
      return !processIsNull(this.case_.process);
    },
  },

  methods: {
    handleChangeApplicant(applicant: ApplicantSerializer) {
      if (!applicant) {
        // FIXME: why
        console.log("ERROR: applicant is", JSON.stringify(applicant));
        return;
      }
      this.case_.applicant = applicant;
    },

    // FIXME: this is updating the processes to match country, nationality, home
    // country, dates, so it needs to be triggered accordingly.
    async handleChangeHostCountry(country: CountrySerializer) {
      if (!country) {
        // FIXME: why
        console.log("ERROR: country is", JSON.stringify(country));
        return;
      }
      this.case_.process.route.host_country = country;
      if (this.case_.applicant.nationalities) {
        const nationalityCodes = this.case_.applicant.nationalities.map(
          (country) => country.code
        );
        this.processes =
          (await http.fetchDataOrNull(
            `/api/processes/?host_country=${
              country.code
            }&nationalities=${nationalityCodes.join(",")}`
          )) || [];
      }
    },

    handleChangeProcess(process: ProcessSerializer): void {
      this.case_.process = process;
      // Create case steps as a copy of process steps; set provider contact on
      // each step to the provider contact that the user has chosen (or the
      // initial null value).
      this.case_.steps = process.steps.map((s, i) => ({
        active_contract: {
          provider_contact: this.defaultProviderContact,
        },
        // TODO: Use enum labels instead of display names
        state: {
          name: "FREE",
          value: "Waiting for client to offer to provider",
        },
        actions: [],
        process_step: s,
        sequence_number: i + 1,
        stored_files: [],
      }));
      // Changing the steps often makes a large difference to the vertical
      // height of the Case component at the top of the page.
      const submitButton = this.$refs.submitButton as HTMLElement;
      this.$nextTick(() => submitButton.scrollIntoView());
    },

    handleSelectProviderContact(
      providerContact: ProviderContactSerializer
    ): void {
      this.defaultProviderContact = providerContact;
      for (let step of this.case_.steps) {
        step.active_contract.provider_contact = providerContact;
      }
    },

    handleInputDateRange([entryDate, exitDate]: [Date, Date]): void {
      this.case_.target_entry_date = dateToYYYYMMDD(entryDate);
      this.case_.target_exit_date = dateToYYYYMMDD(exitDate);
    },

    async handleSubmit(): Promise<void> {
      // TODO: validation
      const httpResponse = await http.post("/api/client-contact/create-case/", {
        body: JSON.stringify(this.case_),
      });
      if (httpResponse.ok) {
        const response = await httpResponse.json();
        showMessages(response);
        if (response.errors.length > 0) {
          this.validationErrors = response.errors;
        } else {
          const message = `Success! Case created for ${this.case_.applicant.user.first_name} ${this.case_.applicant.user.last_name}.`;
          Notification.open({
            message,
            type: "is-success",
            hasIcon: true,
            position: "is-bottom-right",
          });
          this.case_ = NullCase();
          this.$router.push("/portal/cases/");
        }
      }
    },
  },
});
</script>


