  <template>
  <div>
    <section class="section">
      <case v-if="haveApplicant" :case_="case_"> </case>

      <div class="form pt-6">
        <applicant-selector
          label="Applicant"
          @change:applicant="handleChangeApplicant"
        >
        </applicant-selector>

        <country-selector
          label="Host country"
          @change:country="handleChangeHostCountry"
        >
        </country-selector>

        <b-field label="Target dates">
          <b-datepicker
            :range="true"
            :mobile-native="false"
            @input="handleInputDateRange"
          >
          </b-datepicker>
        </b-field>

        <fieldset :disabled="processes.length === 0">
          <route-selector
            label="Route"
            :processes="processes"
            @change:process="handleChangeProcess"
          >
          </route-selector>
        </fieldset>

        <fieldset :disabled="!haveProcess">
          <provider-contact-selector
            label="Provider"
            :process="case_.process"
            @change:provider-contact="handleChangeProviderContact"
          >
          </provider-contact-selector>
        </fieldset>

        <fieldset>
          <div class="field is-grouped pt-4">
            <div class="control">
              <button class="button is-link" @click="handleSubmit">
                Submit
              </button>
            </div>
          </div>
        </fieldset>
      </div>
      <div>
        <vue-json-pretty
          v-if="validationErrors"
          :path="'res'"
          :data="validationErrors"
          class="mt-4"
        >
        </vue-json-pretty>
      </div>
    </section>
  </div>
</template>

<script lang="ts">
import Vue from "vue";
import Cookies from "js-cookie";

import VueJsonPretty from "vue-json-pretty";
import "vue-json-pretty/lib/styles.css";

import {
  CountrySerializer,
  ApplicantSerializer,
  ProcessSerializer,
  ProviderContactSerializer,
} from "../autogenerated-interfaces";
import Case from "../components/Case.vue";
import {
  NullCase,
  applicantIsNull,
  processIsNull,
  NullProviderContact,
} from "@/factories";
import CountrySelector from "./CountrySelector.vue";
import ApplicantSelector from "./ApplicantSelector.vue";
import ProviderContactSelector from "./ProviderContactSelector.vue";
import RouteSelector from "./RouteSelector.vue";
import http from "../http";
import { dateToYYYYMMDD } from "../utils";

export default Vue.extend({
  components: {
    Case,
    CountrySelector,
    ApplicantSelector,
    ProviderContactSelector,
    RouteSelector,
    VueJsonPretty,
  },

  data() {
    return {
      case_: NullCase(),
      input: {
        route: "",
      },
      // All processes matching country, applicant nationalities & home country, dates
      processes: [] as ProcessSerializer[],
      // Subset of those processes matching selected route
      validationErrors: null as object | null,
      // Provider contacts are linked indendently to each case step; the case
      // itself does not have a provider contact. However, the form gives the
      // appearance to the user that they are selecting a single provider
      // contact for the case. This is stored in the following value, and is
      // copied to each of the case steps.
      defaultProviderContact: NullProviderContact() as ProviderContactSerializer,
    };
  },

  computed: {
    haveApplicant(): boolean {
      return !applicantIsNull(this.case_.applicant);
    },

    haveProcess(): boolean {
      return !processIsNull(this.case_.process);
    },
  },

  methods: {
    handleChangeApplicant(applicant: ApplicantSerializer) {
      if (!applicant) {
        // FIXME: why
        console.log("ERROR: applicant is", JSON.stringify(applicant));
        return;
      }
      this.case_.applicant = applicant;
    },

    // FIXME: this is updating the processes to match country, nationality, home
    // country, dates, so it needs to be triggered accordingly.
    handleChangeHostCountry(country: CountrySerializer) {
      if (!country) {
        // FIXME: why
        console.log("ERROR: country is", JSON.stringify(country));
        return;
      }
      this.case_.process.route.host_country = country;
      if (this.case_.applicant.nationalities) {
        const nationalityCodes = this.case_.applicant.nationalities.map(
          (country) => country.code
        );
        http
          .get(
            `${process.env.VUE_APP_SERVER_URL}/api/processes/?host_country=${
              country.code
            }&nationalities=${nationalityCodes.join(",")}`
          )
          .then((resp) => resp.json())
          .then((data) => (this.processes = data));
      }
    },

    handleChangeProcess(process: ProcessSerializer): void {
      this.case_.process = process;
      // Create case steps as a copy of process steps; set provider contact on
      // each step to the provider contact that the user has chosen (or the
      // initial null value).
      this.case_.steps = process.steps.map((s, i) => ({
        active_contract: {
          provider_contact: this.defaultProviderContact,
        },
        // TODO: Use enum labels instead of display names
        state: "Waiting for client to offer to provider",
        actions: [],
        process_step: s,
        sequence_number: i + 1,
        stored_files: [],
      }));
    },

    handleChangeProviderContact(
      providerContact: ProviderContactSerializer
    ): void {
      this.defaultProviderContact = providerContact;
      for (let step of this.case_.steps) {
        step.active_contract.provider_contact = providerContact;
      }
    },

    handleInputDateRange([entryDate, exitDate]: [Date, Date]): void {
      this.case_.target_entry_date = dateToYYYYMMDD(entryDate);
      this.case_.target_exit_date = dateToYYYYMMDD(exitDate);
    },

    async handleSubmit(): Promise<void> {
      // TODO: validation

      const headers = {
        "Content-Type": "application/json",
      } as any;
      const csrf_token = Cookies.get("csrftoken");
      if (csrf_token) {
        headers["X-CSRFToken"] = csrf_token;
      }

      const response = await fetch(
        `${process.env.VUE_APP_SERVER_URL}/api/client-contact/create-case/`,
        {
          method: "POST",
          headers,
          body: JSON.stringify(this.case_),
        }
      );
      const data = await response.json();
      if (data.errors) {
        this.validationErrors = data.errors;
      } else {
        this.case_ = NullCase();
        this.$router.push("/portal/cases/");
      }
    },
  },
});
</script>


