<template>
  <b-table
    ref="table"
    :data="rows"
    :paginated="paginated"
    :per-page="10"
    :focusable="focusable"
    :selected.sync="selectedRowProxy"
    @dblclick="(row) => $emit('dblclick', row)"
    hoverable
  >
    <b-table-column
      v-if="columnSpec.applicant"
      label="Applicant"
      v-slot="props"
    >
      <editable-applicant
        :applicant="props.row.applicant"
        :editingSpec="caseSpec(props.index, 'applicant')"
      />
    </b-table-column>

    <b-table-column
      v-if="columnSpec.hostCountry"
      label="Host Country"
      v-slot="props"
    >
      <editable-country
        :country="
          props.row.process &&
          props.row.process.route &&
          props.row.process.route.host_country
        "
        :editingSpec="caseSpec(props.index, 'hostCountry')"
      />
    </b-table-column>

    <b-table-column v-if="columnSpec.dateRange" label="Dates" v-slot="props">
      <editable-date-range
        :dateRange="[
          props.row.move.target_entry_date,
          props.row.move.target_exit_date,
        ]"
        :editingSpec="caseSpec(props.index, 'dateRange')"
      />
    </b-table-column>

    <b-table-column
      v-if="columnSpec.contractLocation"
      label="Contract location"
      v-slot="props"
    >
      <editable-contract-or-payroll-location
        :value="props.row.move.contract_location"
        id="contract-location"
        :editingSpec="caseSpec(props.index, 'contractLocation')"
      />
    </b-table-column>

    <b-table-column
      v-if="columnSpec.payrollLocation"
      label="Payroll location"
      v-slot="props"
    >
      <editable-contract-or-payroll-location
        :value="props.row.move.payroll_location"
        id="payroll-location"
        :editingSpec="caseSpec(props.index, 'payrollLocation')"
      />
    </b-table-column>

    <b-table-column
      v-if="columnSpec.salary"
      label="Annual salary"
      v-slot="props"
    >
      <editable-salary
        :currencyCode="props.row.move.host_country.currency_code"
        :editingSpec="caseSpec(props.index, 'salary')"
      />
    </b-table-column>

    <b-table-column v-if="columnSpec.route" label="Route" v-slot="props">
      <editable-route
        :route="props.row.process.route"
        :editingSpec="caseSpec(props.index, 'route')"
      />
    </b-table-column>

    <b-table-column v-if="columnSpec.provider" label="Provider" v-slot="props">
      <editable-provider
        :process="props.row.process"
        :steps="props.row.steps"
        :editingSpec="caseSpec(props.index, 'provider')"
      />
    </b-table-column>
  </b-table>
</template>

<script lang="ts">
import Vue, { PropType } from "vue";

import { CaseSerializer } from "@/autogenerated-interfaces";
import EditableApplicant from "../components/EditableApplicant.vue";
import EditableCountry from "../components/EditableCountry.vue";
import EditableDateRange from "../components/EditableDateRange.vue";
import EditableProvider from "../components/EditableProvider.vue";
import EditableRoute from "../components/EditableRoute.vue";
import EditableSalary from "./EditableSalary.vue";
import { CaseSpec, EditingSpec } from "@/editable-component";
import EditableContractOrPayrollLocation from "./EditableContractOrPayrollLocation.vue";

export default Vue.extend({
  props: {
    rows: Array as PropType<CaseSerializer[]>,
    columnSpec: Object as PropType<CaseSpec>,
    caseSpecs: Array as PropType<CaseSpec[] | null>,
    selected: Object,
    // TODO: focusable must always be true when using `selected`?
    focusable: Boolean,
    paginated: {
      type: Boolean,
      default: false,
    },
  },
  components: {
    EditableCountry,
    EditableDateRange,
    EditableApplicant,
    EditableProvider,
    EditableRoute,
    EditableSalary,
    EditableContractOrPayrollLocation,
  },

  data() {
    return {
      selectedRowProxy: {},
    };
  },

  watch: {
    selectedRowProxy: function (row) {
      // This is slightly convoluted. This component is standing downstream of a
      // view, and upstream of b-table. But the b-table selected row feature
      // doesn't really seem to be designed for that: it requires the use of
      // :selected.sync=x, therefore `x` must be owned data, not the prop that
      // the upstream view has passed in. So, this intermediate component owns
      // some data (this.selectedRowProxy), and that data is updated by the
      // required selected.sync with the downstream b-table, and this watcher
      // notifies the upstream view when the selected row changes.
      this.$emit("update:selected", row);
    },
  },

  methods: {
    caseSpec(index: number, property: string): EditingSpec {
      return (
        (this.caseSpecs &&
          this.caseSpecs[index] &&
          ((this.caseSpecs[index] as CaseSpec)[property] as EditingSpec)) || {
          editable: false,
          disabled: false,
        }
      );
    },
  },
});
</script>

<style>
.table tr.is-selected {
  background-color: #eeeeee !important;
  color: currentColor;
}
</style>
