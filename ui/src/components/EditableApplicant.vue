<template>
  <fieldset
    v-if="canUpdate && state === State.Selecting"
    :disabled="editingSpec.disabled"
  >
    <applicant-selector
      ref="selector"
      :candidateApplicants="candidateApplicants"
      @select:applicant="handleSelect"
      @blur="editableComponentProxy.handleSelectorBlur()"
      class="applicant-selector"
    />
  </fieldset>
  <div v-else @click="editableComponentProxy.handleDisplayerClick()">
    <applicant
      :applicant="applicant"
      :applicantEditable="editingSpec.editable"
    />
  </div>
</template>

<script lang="ts">
import Vue, { PropType } from "vue";

import Applicant from "./Applicant.vue";
import ApplicantSelector from "./ApplicantSelector.vue";
import {
  EditableComponentProxy,
  EditingSpec,
  State,
} from "../editable-component";
import { ApplicantSerializer } from "../autogenerated-interfaces";
import { applicantIsNull } from "@/factories";
import { isClientContact } from "@/role";
import eventBus from "@/event-bus";
import http from "../http";

export default Vue.extend({
  props: {
    applicant: Object as PropType<ApplicantSerializer>,
    editingSpec: Object as PropType<EditingSpec>,
    disabled: {
      type: Boolean,
      default: false,
    },
  },

  components: {
    Applicant,
    ApplicantSelector,
  },

  data() {
    return {
      state: State.Selecting,
      candidateApplicants: [] as ApplicantSerializer[],
      State,
    };
  },

  async created() {
    this.state = this.hasDisplayable ? State.Displaying : State.Selecting;
    if (this.canUpdate) {
      this.candidateApplicants =
        (await http.fetchDataOrNull("/api/client-contact/applicants/")) || [];
    }
  },

  computed: {
    editableComponentProxy(): EditableComponentProxy {
      return new EditableComponentProxy(this);
    },

    hasDisplayable(): boolean {
      return !applicantIsNull(this.applicant);
    },

    // TODO: make this a method
    canUpdate(): boolean {
      return isClientContact() && this.editingSpec.editable;
    },
  },

  methods: {
    handleSelect(applicant: ApplicantSerializer) {
      if (!applicant) {
        // FIXME: why
        console.log("ERROR: applicant is", JSON.stringify(applicant));
        return;
      }
      eventBus.$emit("update:applicant", applicant);
      // We've just selected a value, so show the rich display of the value
      // instead of the value in the selection widget.
      this.state = State.Displaying;
    },
  },
});
</script>
