<template>
  <b-table ref="table" :data="steps" detailed :show-detail-icon="false">
    <b-table-column label="Step" v-slot="props">
      <span class="has-text-weight-bold">
        {{ props.row.sequence_number }}.
        {{ props.row.process_step.service.name }}
      </span>
    </b-table-column>

    <b-table-column label="Provider" v-slot="props">
      <provider-contact-selector
        v-if="canChangeProviderContact(props.row)"
        placeholder="Select Provider"
        :process="case_.process"
        :current="
          props.row.active_contract &&
          props.row.active_contract.provider_contact
        "
        :initialProviderContacts="providerContacts"
        @change:provider-contact="
          (providerContact) =>
            handleChangeProviderContact(providerContact, props.index)
        "
      >
      </provider-contact-selector>
      <provider-contact
        v-else-if="
          props.row.active_contract &&
          props.row.active_contract.provider_contact
        "
        :provider_contact="props.row.active_contract.provider_contact"
        class="mr-3"
      >
      </provider-contact>
    </b-table-column>

    <b-table-column label="Status" v-slot="props">
      {{ props.row.state.value }}
    </b-table-column>

    <b-table-column label="Actions" v-slot="props">
      <ul>
        <li v-for="action of props.row.actions" :key="action.url">
          <action-button
            class="mb-2"
            :action="action"
            :object="props.row"
            @action:success="(caseStep) => updateRow(caseStep, props.index)"
          >
          </action-button>
        </li>
      </ul>
    </b-table-column>

    <b-table-column v-slot="props">
      <template>
        <a @click="props.toggleDetails(props.row)"> Manage files </a>
      </template>
    </b-table-column>

    <template #detail="props">
      <case-step-file-upload-area :step="props.row">
      </case-step-file-upload-area>
    </template>
  </b-table>
</template>

<script lang="ts">
import Vue, { PropType } from "vue";

import BTable from "buefy/src/components/table";
type BTableInstance = InstanceType<typeof BTable>;

import ActionButton from "./ActionButton.vue";
import CaseStepFileUploadArea from "./CaseStepFileUploadArea.vue";
import ProviderContact from "../components/ProviderContact.vue";
import ProviderContactSelector from "../components/ProviderContactSelector.vue";
import {
  CaseSerializer,
  CaseStepSerializer,
  ProcessSerializer,
  ProviderContactSerializer,
} from "../autogenerated-interfaces";
import { NullCaseStepContract, processIsNull } from "@/factories";
import http from "../http";
import { isClientContact } from "../role";

export default Vue.extend({
  components: {
    ActionButton,
    CaseStepFileUploadArea,
    ProviderContact,
    ProviderContactSelector,
  },

  props: {
    case_: Object as PropType<CaseSerializer>,
    steps: Array as PropType<CaseStepSerializer[]>,
  },

  data() {
    return {
      providerContacts: [] as ProviderContactSerializer[],
    };
  },

  created() {
    if (isClientContact() && !processIsNull(this.case_.process)) {
      this.fetchProviderContacts(this.case_.process);
    }
  },

  methods: {
    updateRow(caseStep: CaseStepSerializer | null, index: number) {
      const table = this.$refs.table as BTableInstance;
      if (caseStep) {
        table.visibleData.splice(index, 1, caseStep);
      } else {
        table.visibleData.splice(index, 1);
      }
    },

    canChangeProviderContact(row: CaseStepSerializer): boolean {
      if (!isClientContact()) {
        return false;
      }
      for (let action of row.actions) {
        if (action.name == "client_contact_earmark_case_step") {
          return true;
        }
      }
      return false;
    },

    // TODO: duplicated in ProviderContactSelector.vue
    fetchProviderContacts(process_: ProcessSerializer) {
      if (!process_.uuid) {
        // TODO: why?
        return;
      }
      http
        .get(
          `/api/client-contact/list-provider-contacts/?process_uuid=${process_.uuid}`
        )
        .then((resp) => resp.json())
        .then((data) => (this.providerContacts = data));
    },

    handleChangeProviderContact(
      providerContact: ProviderContactSerializer,
      index: number
    ) {
      const table = this.$refs.table as BTableInstance;
      const row: CaseStepSerializer = table.visibleData[index];
      if (!row.active_contract) {
        row.active_contract = NullCaseStepContract();
      }
      row.active_contract.provider_contact = providerContact;
      table.visibleData.splice(index, 1, row);
    },
  },
});
</script>

<style scoped>
a,
a:hover {
  color: currentColor;
  text-decoration: underline;
}
</style>